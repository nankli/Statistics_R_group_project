---
title: "EDA"
author: "Matt Pitz, Nan Li, Ada Guan"
date: '2022-04-03'
output: html_document
---

```{r load packages and set options, include=FALSE}
library(tidyverse) 
library(magrittr)
library(knitr)
if (!require("patchwork")) install.packages('patchwork')
if (!require("moments")) install.packages('moments')
if (!require("arrow")) install.packages('arrow')
library(patchwork)
library(moments)
library(arrow)
library(readr)
library(ggplot2)
#tinytex::install_tinytex()
theme_set(theme_bw())

options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE)

notebooks_path <- getwd()
root_path <- dirname(notebooks_path)
data_path <- file.path(root_path,"src","data","raw")
```

```{r load in clean data}
post_1990_merge <- read_parquet(file = file.path(data_path, "post_1990_clean_data"))
```


### EDA
```{r, scatter plot}
post_1990_raw_histogram <- post_1990_merge %>%
filter(box_office != "" & budget != "") %>%
  ggplot() + 
  aes(x = clean_budget_real, y = clean_box_office_real, color = genre_primary) +
  geom_point() +
    labs(title ='Box Office Earning Based On Budget',
       x ='Budget (Million $)',
       y ='Box Office (Million $)')

post_1990_raw_histogram
```

```{r select columns of interests for EDA}
post_1990_raw <- post_1990_merge[c('title','maturity_rating','duration_minutes',
                                   'clean_box_office_real','clean_budget_real',
                                   'genre_primary','rotten_tomatoes_rating',
         'release_year','release_month','summer','thanksxmas','received_award')]
post_1990 <- na.omit(post_1990_raw)

summary(post_1990)

```

```{r EDA, histograms for box office using +1 action for study purpose}
p1 <- post_1990 %>%
  ggplot() + aes(x=clean_box_office_real) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of box office', x = 'Box office (Million $)', y = 'Frequency')
#added 1 to the box_office to avoid negative values after log transformation
p2 <- post_1990 %>%
  ggplot() + aes(x=log(clean_box_office_real + 1)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(box office)', x = 'log(Box office + 1) (Million $)', y = 'Frequency')
p1|p2
```
```{r EDA, histograms for budget using +1 action for study purpose}
p3 <- post_1990 %>%
  ggplot() + aes(x=clean_budget_real) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of budget', x = 'Budget (Million $)', y = 'Frequency')

p4 <- post_1990 %>%
  ggplot() + aes(x=log(clean_budget_real + 1)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(budget)', x = 'log(Budget + 1) (Million $)', y = 'Frequency')
p3|p4
```
The histogram shows that the log transformation is necessary for the budget and box office data. And we can also see there are outliers in both of these variables.
```{r EDA, check and remove extreme outliers from box office}
post_1990_filtered <- post_1990_raw %>%
  filter(clean_box_office_real >= 1.0 & clean_budget_real >=1.0)
         
p5 <- post_1990_filtered  %>%
  ggplot() + aes(x = "", y = clean_box_office_real) + geom_boxplot(fill = "#0c4c8a") + theme_minimal() + labs(title = 'Boxplot of box office', y = 'Box office (Million $)')

#out <-boxplot.stats(post_1990_filtered$clean_box_office_real)$out
#out_ind <- which(post_1990_filtered$clean_box_office_real %in% c(out))
#out_ind

p6 <- post_1990_filtered  %>%
  ggplot() + aes(x = "", y = clean_budget_real) + geom_boxplot(fill = "#0c4c8a") + theme_minimal() + labs(title = 'Boxplot of budget', y = 'budget (Million $)')

p5|p6

```


```{r EDA, histograms for box office, removed values between 0 and 1 for models}
#only remove extreme outliers
post_1990_filtered <- post_1990_filtered %>%
  filter(clean_box_office_real < 1990 & clean_budget_real <350)

p1_1 <- post_1990_filtered %>%
  ggplot() + aes(x=clean_box_office_real) + geom_histogram(position ='dodge', bins=40) + labs(title = 'Distribution of box office', x = 'Box office (Million $)', y = 'Frequency')

p2_1 <- post_1990_filtered %>%
  ggplot() + aes(x=log(clean_box_office_real)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(Box office)', x = 'log(Box office) (Million $)', y = 'Frequency')
p1_1|p2_1
```
```{r EDA, histograms for budget, removed values between 0 and 1 for models}
#only remove extreme outliers
post_1990_filtered <- post_1990_filtered %>%
  filter(clean_box_office_real < 1990 & clean_budget_real <350)
p3_1 <- post_1990_filtered %>%
  ggplot() + aes(x=clean_budget_real) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of budget', x = 'Budget (Million $)', y = 'Frequency')

p4_1 <- post_1990_filtered %>%
  ggplot() + aes(x=log(clean_budget_real)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(Budget)', x = 'log(Budget) (Million $)', y = 'Frequency')
p3_1|p4_1

```
Next, we will take a look at the correlation between numerical variables.
correlation matrix is applied here. 

```{r EDA, correlation matrix}
if (!require("GGally")) install.packages('GGally')
post_1990 <- post_1990 %>% 
  mutate(
    box_office_log = log(clean_box_office_real), 
    budget_log = log(clean_budget_real)
  )
post_1990 %>%
  select(box_office_log, budget_log, duration_minutes,rotten_tomatoes_rating) %>%
  GGally::ggpairs()
```
```{r box office and binary variable (recieved_award and release_month) }
p7 <- post_1990 %>%
  ggplot() + aes(x=clean_budget_real, y=log(clean_box_office_real), color=received_award) + geom_point(show.legend=FALSE) + labs(title = 'Effects of Awards Recieved', x = 'Budget (Million $)', y = 'Box Office (Million $)', color = 'Received\nAward')
p7

p8 <- post_1990 %>%
  ggplot() + aes(x=received_award, y=log(clean_box_office_real)) + geom_boxplot() + labs(title = 'Effects of Awards Recieved', x = 'Received Award', y = 'Box Office (Million $)')
p8

p7|p8
```
