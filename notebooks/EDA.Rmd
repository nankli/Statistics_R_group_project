---
title: "EDA"
author: "Matt Pitz, Nan Li, Ada Guan"
date: '2022-04-03'
output: html_document
---

```{r load packages and set options, include=FALSE}
library(tidyverse) 
library(magrittr)
library(knitr)
if (!require("patchwork")) install.packages('patchwork')
if (!require("moments")) install.packages('moments')
if (!require("arrow")) install.packages('arrow')
library(patchwork)
library(moments)
library(arrow)
library(readr)
library(ggplot2)
#tinytex::install_tinytex()
theme_set(theme_bw())

options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE, message=FALSE)

notebooks_path <- getwd()
root_path <- dirname(notebooks_path)
data_path <- file.path(root_path,"src","data","raw")
```

```{r load in clean data}
post_1990_merge <- read_parquet(file = file.path(data_path, "post_1990_clean_data"))
```


### EDA
```{r, scatter plot bo}
post_1990_raw_scatter <- post_1990_merge %>%
filter(box_office != "" & budget != "") %>%
  ggplot() + 
  aes(x = clean_budget_real, y = clean_box_office_real, color = genre_primary) +
  geom_point() +
    labs(title ='Box Office Earning Based On Budget',
       x ='Budget (Million $)',
       y ='Box Office (Million $)',
       color = 'Genre')

post_1990_raw_scatter
```

```{r maturity rating vs box office and budget}
post_1990_raw_scatter <- post_1990_merge %>%
filter(box_office != "" & budget != "") %>%
  ggplot() + 
  aes(x = clean_budget_real, y = clean_box_office_real, color = maturity_rating) +
  geom_point() +
    labs(title ='Box Office Earning Based On Budget',
       x ='Budget (Million $)',
       y ='Box Office (Million $)',
       color = 'Maturity Rating')

post_1990_raw_scatter
```


```{r select columns of interests for EDA}
post_1990_raw <- post_1990_merge[c('title','maturity_rating','duration_minutes',
                                   'clean_box_office_real','clean_budget_real',
                                   'genre_primary','rotten_tomatoes_rating',
         'release_year','release_month','summer','thanksxmas','received_award','meta_critic_rating')]
post_1990 <- na.omit(post_1990_raw)

summary(post_1990)

```

```{r describe categorical data, echo=FALSE, message=TRUE, warning=TRUE}
attach(post_1990,warn.conflicts = FALSE)
unique(maturity_rating)
unique(genre_primary)
unique(release_month)
```
```{r}
mrating<-setNames(aggregate(clean_box_office_real, list(maturity_rating), FUN=sum,na.rm = TRUE),c('Ratings','Box Office Sales'))

data.frame(mrating[order(mrating$`Box Office Sales`,mrating$Ratings),])
```

```{r}
attach(post_1990_merge %>%
filter(box_office != "" & budget != ""),warn.conflicts = FALSE)
mrating<-setNames(aggregate(clean_box_office_real, list(maturity_rating), FUN=length),c('Ratings','Number of Movies'))

data.frame(mrating[order(mrating$`Number of Movies`,mrating$Ratings),])
```

```{r}
attach(post_1990_merge %>%
filter(box_office != "" & budget != ""),warn.conflicts = FALSE)
years<-setNames(aggregate(title, list(release_year), FUN=length),c('Year','Number of Movies'))
years
data.frame(years[order(years$Year,years$`Number of Movies`),])
```
```{r}
attach(post_1990_merge %>%
filter(box_office != "" & budget != ""),warn.conflicts = FALSE)
genre_rating<-setNames(aggregate(clean_box_office_real, list(genre_primary,maturity_rating), FUN=length),c('Genre','Rating','Number of Movies'))
genre_rating
genre_rating<-data.frame(genre_rating[order(genre_rating$`Number of Movies`,decreasing = TRUE),])

genre_rating
head(genre_rating)
```


The histogram shows that the log transformation is necessary for the budget and box office data. And we can also see there are outliers in both of these variables.
```{r EDA, check and remove extreme outliers from box office}
post_1990_filtered <- post_1990_raw %>%
  filter(clean_box_office_real >= 1.0 & clean_budget_real >=1.0)
         
p5 <- post_1990_filtered  %>%
  ggplot() + aes(x = "", y = clean_box_office_real) + geom_boxplot(fill = "#0c4c8a") + theme_minimal() + labs(title = 'Boxplot of box office', y = 'Box office (Million $)')

#out <-boxplot.stats(post_1990_filtered$clean_box_office_real)$out
#out_ind <- which(post_1990_filtered$clean_box_office_real %in% c(out))
#out_ind

p6 <- post_1990_filtered  %>%
  ggplot() + aes(x = "", y = clean_budget_real) + geom_boxplot(fill = "#0c4c8a") + theme_minimal() + labs(title = 'Boxplot of budget', y = 'budget (Million $)')

p5|p6

```


```{r EDA, histograms for box office, removed values between 0 and 1 for models}
#only remove extreme outliers
post_1990_filtered <- post_1990_filtered %>%
  filter(clean_box_office_real < 1990 & clean_budget_real <350)

p1 <- post_1990_filtered %>%
  ggplot() + aes(x=clean_box_office_real) + geom_histogram(position ='dodge', bins=40) + labs(title = 'Distribution of box office', x = 'Box office (Million $)', y = 'Frequency')

p2 <- post_1990_filtered %>%
  ggplot() + aes(x=log(clean_box_office_real)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(Box office)', x = 'log(Box office) (Million $)', y = 'Frequency')
p1|p2
```
```{r EDA, histograms for budget, removed values between 0 and 1 for models}
#only remove extreme outliers
post_1990_filtered <- post_1990_filtered %>%
  filter(clean_box_office_real < 1990 & clean_budget_real <350)
p3 <- post_1990_filtered %>%
  ggplot() + aes(x=clean_budget_real) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of budget', x = 'Budget (Million $)', y = 'Frequency')

p4 <- post_1990_filtered %>%
  ggplot() + aes(x=log(clean_budget_real)) + geom_histogram(position ='dodge', bins=30) + labs(title = 'Distribution of log(Budget)', x = 'log(Budget) (Million $)', y = 'Frequency')
p3|p4

```
Next, we will take a look at the correlation between numerical variables.
correlation matrix is applied here. 

```{r EDA, correlation matrix}
if (!require("GGally")) install.packages('GGally')
post_1990_filtered <- post_1990_filtered %>% 
  mutate(
    box_office_log = log(clean_box_office_real), 
    budget_log = log(clean_budget_real)
  )
post_1990_filtered %>%
  select(box_office_log, budget_log, duration_minutes,meta_critic_rating) %>%
  GGally::ggpairs()
```

